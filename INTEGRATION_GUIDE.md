# Руководство по интеграции с no-code платформой

## Общая информация

Ваша no-code платформа должна отправлять HTTP POST запросы на endpoint `/api/leads` каждый раз, когда получен новый лид.

## Настройка интеграции

### Endpoint URL

```
http://your-domain.com/api/leads
```

Для локального тестирования:
```
http://localhost:3001/api/leads
```

### Метод
```
POST
```

### Headers
```
Content-Type: application/json
```

### Body формат

```json
{
  "name": "{{имя_клиента}}",
  "city": "{{город}}",
  "selected_car": "{{выбранный_автомобиль}}",
  "purchase_method": "{{способ_покупки}}",
  "client_quality": {{качество_0_100}},
  "traffic_source": "{{источник}}",
  "summary_dialog": "{{резюме_диалога}}"
}
```

## Поля данных

| Поле | Тип | Обязательное | Описание | Пример |
|------|-----|--------------|----------|--------|
| name | string | Да | Имя клиента | "Асхат Нұрлан" |
| city | string | Да | Город клиента | "Алматы" |
| selected_car | string | Да | Выбранная модель автомобиля | "Kia Sportage" |
| purchase_method | string | Да | Способ покупки | "кредит", "наличные", "trade-in" |
| client_quality | number | Да | Качество лида от 0 до 100 | 85 |
| traffic_source | string | Да | Источник обращения | "Instagram", "WhatsApp", "2GIS" |
| summary_dialog | string | Да | Краткое резюме диалога | "Клиент готов к покупке..." |

## Валидация

API автоматически проверяет:
- ✅ Все обязательные поля присутствуют
- ✅ client_quality - число от 0 до 100
- ✅ Все строковые поля не пустые

## Примеры успешных запросов

### Пример 1: Лид из Instagram
```json
{
  "name": "Айгуль Сапарова",
  "city": "Астана",
  "selected_car": "Kia Seltos",
  "purchase_method": "наличные",
  "client_quality": 92,
  "traffic_source": "Instagram",
  "summary_dialog": "Клиентка интересуется покупкой Kia Seltos в максимальной комплектации. Готова оформить сделку в течение недели. Хочет получить дополнительную информацию о цвете и опциях."
}
```

### Пример 2: Лид из WhatsApp
```json
{
  "name": "Ерлан Токаев",
  "city": "Шымкент",
  "selected_car": "Kia K5",
  "purchase_method": "кредит",
  "client_quality": 75,
  "traffic_source": "WhatsApp",
  "summary_dialog": "Клиент интересуется кредитом на 5 лет. Нужна консультация по ставкам и первоначальному взносу. Планирует приехать на тест-драйв на выходных."
}
```

### Пример 3: Лид из 2GIS
```json
{
  "name": "Дина Жаксылыкова",
  "city": "Караганда",
  "selected_car": "Kia Sorento",
  "purchase_method": "trade-in",
  "client_quality": 68,
  "traffic_source": "2GIS",
  "summary_dialog": "Клиентка хочет обменять текущий автомобиль (Toyota RAV4 2018) на Kia Sorento. Интересует оценка trade-in и условия обмена."
}
```

## Ответы API

### Успешный ответ (201 Created)
```json
{
  "message": "Лид успешно добавлен",
  "lead": {
    "id": 15,
    "name": "Айгуль Сапарова",
    "city": "Астана",
    "selectedCar": "Kia Seltos",
    "purchaseMethod": "наличные",
    "clientQuality": 92,
    "trafficSource": "Instagram",
    "summaryDialog": "Клиентка интересуется...",
    "createdAt": "2025-12-11T15:30:00.000Z"
  }
}
```

### Ошибка валидации (400 Bad Request)
```json
{
  "error": "Все поля обязательны для заполнения"
}
```

или

```json
{
  "error": "client_quality должен быть числом от 0 до 100"
}
```

### Ошибка сервера (500 Internal Server Error)
```json
{
  "error": "Внутренняя ошибка сервера"
}
```

## Настройка в популярных no-code платформах

### Make.com (Integromat)

1. Создайте новый сценарий
2. Добавьте модуль "HTTP Request"
3. Настройте параметры:
   - URL: `http://your-domain.com/api/leads`
   - Method: POST
   - Headers: `Content-Type: application/json`
   - Body: JSON с вашими данными
4. Подключите модуль к триггеру получения нового лида

### Zapier

1. Создайте новый Zap
2. Выберите триггер (источник лидов)
3. Добавьте действие "Webhooks by Zapier"
4. Выберите "POST"
5. Укажите URL: `http://your-domain.com/api/leads`
6. В Body укажите JSON с маппингом полей
7. В Headers добавьте `Content-Type: application/json`

### n8n

1. Создайте новый workflow
2. Добавьте триггер для получения лидов
3. Добавьте узел "HTTP Request"
4. Настройте:
   - Method: POST
   - URL: `http://your-domain.com/api/leads`
   - Body Type: JSON
   - Укажите маппинг полей

### Webhook прямой интеграции

Если ваша платформа поддерживает webhook'и:

1. Перейдите в настройки webhook'ов
2. Создайте новый webhook
3. URL: `http://your-domain.com/api/leads`
4. Method: POST
5. Content-Type: application/json
6. Настройте маппинг полей согласно документации

## Тестирование интеграции

### Шаг 1: Проверьте доступность API
```bash
curl http://your-domain.com/api/leads
```

### Шаг 2: Отправьте тестовый запрос
```bash
curl -X POST http://your-domain.com/api/leads \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тест Клиент",
    "city": "Алматы",
    "selected_car": "Kia Sportage",
    "purchase_method": "кредит",
    "client_quality": 85,
    "traffic_source": "Instagram",
    "summary_dialog": "Тестовый лид для проверки интеграции"
  }'
```

### Шаг 3: Проверьте в дашборде
1. Откройте http://your-domain.com
2. Войдите в систему
3. Проверьте, что тестовый лид появился в таблице

## Мониторинг интеграции

После настройки интеграции рекомендуется:

1. **Проверять логи** - все ошибки логируются на сервере
2. **Настроить уведомления** - о неудачных запросах
3. **Мониторить задержки** - API должен отвечать быстро (< 1 сек)
4. **Тестировать регулярно** - отправляйте тестовые лиды раз в неделю

## Устранение проблем

### Проблема: Получаю ошибку 400
**Решение:** Проверьте, что все обязательные поля присутствуют и client_quality в диапазоне 0-100

### Проблема: Получаю ошибку 500
**Решение:** Проверьте логи сервера, возможно проблема с подключением к базе данных

### Проблема: Запрос отправляется, но данные не появляются
**Решение:** 
1. Проверьте, что получили ответ 201
2. Проверьте подключение к PostgreSQL
3. Обновите страницу дашборда (или подождите автообновления 60 сек)

### Проблема: Не могу достучаться до API
**Решение:**
1. Проверьте, что сервер запущен
2. Проверьте firewall настройки
3. Проверьте, что используете правильный домен/порт

## Безопасность

### Рекомендации:
1. **Используйте HTTPS** в production
2. **Добавьте API ключи** для дополнительной защиты (опционально)
3. **Ограничьте rate limiting** - максимум запросов в минуту
4. **Валидируйте данные** на стороне отправителя
5. **Логируйте все запросы** для аудита

## Масштабирование

При большом потоке лидов (>1000/день):
1. Рассмотрите использование очереди (Redis Queue)
2. Настройте кеширование
3. Оптимизируйте запросы к БД
4. Используйте CDN для статики

## Контакты поддержки

При возникновении проблем с интеграцией:
1. Проверьте логи сервера
2. Проверьте документацию API
3. Отправьте тестовый запрос через curl
4. Проверьте формат данных
